# 6단계: 학생/학부모용 기능 API 구현 — 결과 보고

> 기준 문서: `docs/00-기획-설계-문서.md`, `docs/02-DB-설계-상세.md`, `docs/05-5단계-강사-API-구현-보고.md`  
> 작성일: 2025-02-05

---

## 0. 코드 점검 결과 (실제 코드 기준)

### 0.1 구현 완전성

| 구분 | 요구사항 | 구현 상태 | 비고 |
|------|----------|-----------|------|
| 학생 | GET /api/student/dashboard | ✅ 완료 | class, recentLessons, recentTests, homeworkSummary, attendanceSummary |
| 학생 | GET /api/student/lessons (날짜 필터) | ✅ 완료 | query from, to 선택, validation 적용 |
| 학생 | GET /api/student/tests (점수·평균) | ✅ 완료 | myScore, average 포함 |
| 학생 | GET /api/student/statistics/monthly | ✅ 완료 | year, month 쿼리 필수, 출결·과제 이행률·테스트 평균 |
| 학부모 | GET /api/parent/dashboard | ✅ 완료 | 자녀 1명 기준, 학생 대시보드와 동일 데이터 |
| 학부모 | GET /api/parent/lessons, /tests, /statistics/monthly | ✅ 완료 | parentUserId → 자녀 studentId 후 동일 서비스 |
| 권한 | authenticate + requireRoles | ✅ 완료 | student.routes: ['student'], parent.routes: ['parent'] |
| 데이터 | Lesson/Test 모델 기준 조회 | ✅ 완료 | studentData.service에서만 Lesson, Test 사용 |
| 매핑 | 학생 userId→studentId, 학부모 parentUserId→studentId | ✅ 완료 | Student.findOne({ userId }) / ({ parentUserId }) |

### 0.2 누락 기능

- **없음.** 6단계에서 요청한 학생 4개 API, 학부모 4개 API가 모두 구현되어 있으며, 기획 문서(3.3 학생, 3.4 학부모, 4.4·4.5 화면) 요구사항과 일치합니다.

### 0.3 수정 필요 사항

- **없음.** 별도 수정 계획 없이 현재 코드로 6단계 완료로 간주합니다.

---

## 0.4 빌드 및 실행 안내 (직접 실행용)

**빌드/실행은 Cursor 자동 실행이 아닌, 아래 명령을 사용자께서 직접 터미널에서 실행해 주세요.**

- backend 폴더가 있는 경로로 이동한 뒤, 해당 폴더에서만 `npm` 명령을 실행해야 합니다.

```text
cd "C:\Users\이창현\Desktop\TBC-CLASS\backend"
npm install
npm run build
npm run dev
```

- `npm run build`: TypeScript 컴파일 확인용.  
- `npm run dev`: 서버 기동 및 API 테스트용.  
- API 테스트 시 Postman 등에서 `http://localhost:3001`(또는 config의 port) 기준으로 요청하면 됩니다.

---

## 1. 추가/수정된 파일 목록

### 신규 추가

| 파일 | 설명 |
|------|------|
| `backend/src/services/student/studentData.service.ts` | 학생 기준 데이터 조회 (대시보드, 수업, 테스트, 월별 통계) — 학생/학부모 공통 사용 |
| `backend/src/controllers/student.controller.ts` | 학생 API 컨트롤러 (userId → studentId 매핑 후 서비스 호출) |
| `backend/src/controllers/parent.controller.ts` | 학부모 API 컨트롤러 (parentUserId → 자녀 studentId 매핑 후 동일 서비스 호출) |
| `backend/src/routes/student.routes.ts` | 학생 전용 라우트 (authenticate + requireRoles(['student'])) |
| `backend/src/routes/parent.routes.ts` | 학부모 전용 라우트 (authenticate + requireRoles(['parent'])) |

### 수정

| 파일 | 변경 내용 |
|------|------------|
| `backend/src/app.ts` | `/api/student`, `/api/parent` 라우트 마운트 추가 |

### 공통 사용 (변경 없음)

- `backend/src/middlewares/auth.middleware.ts` — authenticate, requireRoles
- `backend/src/routes/me.routes.ts`, `backend/src/controllers/me.controller.ts`, `backend/src/services/me.service.ts` — 내정보( GET/PUT /api/me, 비밀번호/ID/전화번호 변경 )

---

## 2. 새로 구현된 API 전체 목록

### [A] 공통 – 내 정보 (기존 유지)

| 메서드 | 경로 | 설명 | 권한 |
|--------|------|------|------|
| GET | `/api/me` | 내 정보 조회 | 인증 사용자 |
| PUT | `/api/me/password` | 비밀번호 변경 | 인증 사용자 |
| PUT | `/api/me/loginId` | 로그인 ID 변경 | 인증 사용자 |
| PUT | `/api/me/phone` | 전화번호 변경 | 인증 사용자 |

### [B] 학생용 API (student 역할만)

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/student/dashboard` | 대시보드 (소속 반, 최근 수업/테스트, 과제·출결 요약) |
| GET | `/api/student/lessons` | 진도/과제 현황 (쿼리: from, to 선택) |
| GET | `/api/student/tests` | 테스트 현황 (본인 점수, 반 평균 포함) |
| GET | `/api/student/statistics/monthly` | 월별 통계 (쿼리: year, month 필수) |

### [C] 학부모용 API (parent 역할만)

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/parent/dashboard` | 자녀 대시보드 (학생 대시보드와 동일 구조) |
| GET | `/api/parent/lessons` | 자녀 진도/과제 현황 |
| GET | `/api/parent/tests` | 자녀 테스트 현황 |
| GET | `/api/parent/statistics/monthly` | 자녀 월별 통계 |

- 학생 API: `authenticate` + `requireRoles(['student'])`
- 학부모 API: `authenticate` + `requireRoles(['parent'])`
- 모든 조회는 기존 Lesson / Test 모델 기준이며, 학생은 userId→studentId, 학부모는 parentUserId→자녀 studentId로 매핑 후 동일 서비스 사용.

---

## 3. 각 API별 테스트 방법

### 공통 준비

1. **로그인**  
   - 학생: `POST /api/auth/login` — `loginId`/`password` (또는 전화번호로 자동 생성된 계정)  
   - 학부모: 동일하게 학부모 계정으로 로그인  
2. 응답의 `data.token`을 저장 후, 이후 요청 헤더에 `Authorization: Bearer <token>` 설정.

### 학생용

| API | 방법 |
|-----|------|
| 대시보드 | `GET /api/student/dashboard` + Bearer 토큰(학생) |
| 진도/과제 | `GET /api/student/lessons` 또는 `?from=2025-02-01&to=2025-02-28` |
| 테스트 현황 | `GET /api/student/tests` |
| 월별 통계 | `GET /api/student/statistics/monthly?year=2025&month=2` |

### 학부모용

| API | 방법 |
|-----|------|
| 자녀 대시보드 | `GET /api/parent/dashboard` + Bearer 토큰(학부모) |
| 자녀 진도/과제 | `GET /api/parent/lessons` 또는 `?from=...&to=...` |
| 자녀 테스트 | `GET /api/parent/tests` |
| 자녀 월별 통계 | `GET /api/parent/statistics/monthly?year=2025&month=2` |

- 학생/학부모가 아닌 역할로 호출 시 403.  
- 학생 미배정 또는 학부모 연결 자녀 없으면 해당 API에서 404 또는 빈 요약 반환.

---

## 4. Postman 테스트 예시 (요청/응답)

### 4.1 학생 로그인 후 대시보드

**요청**

```http
GET {{baseUrl}}/api/student/dashboard
Authorization: Bearer {{studentToken}}
```

**응답 예시**

```json
{
  "success": true,
  "data": {
    "class": { "_id": "...", "name": "중1 수학 A반", "description": "" },
    "recentLessons": [
      { "_id": "...", "date": "2025-02-10", "period": "1교시", "progress": "1단원", "homework": "p.10", "homeworkDone": false, "attendanceStatus": "출석" }
    ],
    "recentTests": [
      { "_id": "...", "date": "2025-02-15", "testType": "weeklyTest", "myScore": 85 }
    ],
    "homeworkSummary": { "total": 5, "done": 3, "rate": 60 },
    "attendanceSummary": { "total": 10, "attended": 10, "rate": 100 }
  }
}
```

### 4.2 학생 진도/과제 (날짜 필터)

**요청**

```http
GET {{baseUrl}}/api/student/lessons?from=2025-02-01&to=2025-02-28
Authorization: Bearer {{studentToken}}
```

**응답 예시**

```json
{
  "success": true,
  "data": {
    "lessons": [
      { "_id": "...", "date": "2025-02-10", "period": "1교시", "progress": "1단원", "homework": "p.10", "homeworkDone": true, "attendanceStatus": "출석" }
    ]
  }
}
```

### 4.3 학생 월별 통계

**요청**

```http
GET {{baseUrl}}/api/student/statistics/monthly?year=2025&month=2
Authorization: Bearer {{studentToken}}
```

**응답 예시**

```json
{
  "success": true,
  "data": {
    "year": 2025,
    "month": 2,
    "attendance": { "total": 8, "attended": 8, "rate": 100 },
    "homework": { "total": 6, "done": 4, "rate": 66.67 },
    "testAverage": 82.5,
    "testCount": 2
  }
}
```

### 4.4 학부모 – 자녀 대시보드

**요청**

```http
GET {{baseUrl}}/api/parent/dashboard
Authorization: Bearer {{parentToken}}
```

**응답 예시**  
(학생 대시보드와 동일 구조: class, recentLessons, recentTests, homeworkSummary, attendanceSummary)

### 4.5 학부모 – 자녀 월별 통계

**요청**

```http
GET {{baseUrl}}/api/parent/statistics/monthly?year=2025&month=2
Authorization: Bearer {{parentToken}}
```

**응답 예시**  
(학생 월별 통계와 동일 구조: year, month, attendance, homework, testAverage, testCount)

---

## 5. 기획 문서와의 매핑 설명

| 기획 문서(00-기획-설계-문서.md) | 6단계 구현 내용 |
|--------------------------------|------------------|
| **3.3 학생** – 내 진도 보기, 과제 수행 현황, 테스트 결과 | `GET /api/student/lessons`, `GET /api/student/tests`, 대시보드의 recentLessons/recentTests, homeworkSummary |
| **3.3 학생** – 학습 리포트(기간별 요약) | `GET /api/student/statistics/monthly` (월별 출결·과제 이행률·테스트 평균) |
| **3.3 학생** – 내정보(ID/비밀번호/전화번호 변경) | 기존 `/api/me` 사용 (4단계 구현) |
| **3.4 학부모** – 자녀 진도·과제·테스트 결과 | `GET /api/parent/dashboard`, `/api/parent/lessons`, `/api/parent/tests` (연결된 자녀 1명 기준) |
| **3.4 학부모** – 자녀 학습 리포트(기간별) | `GET /api/parent/statistics/monthly` |
| **3.4 학부모** – 내정보 | 기존 `/api/me` 사용 |
| **4.4 학생** – 홈(내 수업 진도, 최근 과제, 최근 테스트) | `GET /api/student/dashboard` |
| **4.5 학부모** – 자녀 대시보드/진도·과제·테스트 | `GET /api/parent/dashboard`, lessons, tests, statistics/monthly |
| **계정 구조** – 학생 1명 ↔ 학부모 1명 | 학부모는 `Student.parentUserId = 로그인한 User._id`로 자녀 1명만 조회 |
| **권한** – 학생 자신만, 학부모는 연결 자녀만 | 학생: userId→Student 한 건. 학부모: parentUserId→Student 한 건(자녀)으로만 서비스 호출 |

- DB 설계(02-DB-설계-상세.md)의 Lesson, Test, Student, Class 모델을 그대로 사용하며, 별도 컬렉션 추가 없이 기존 모델 기준으로만 조회합니다.

---

**정리**

- 6단계 학생/학부모용 API는 실제 코드 기준으로 요구사항을 모두 충족하며, 누락된 기능 및 수정 필요 사항은 없습니다.
- 빌드·서버 실행은 위 "0.4 빌드 및 실행 안내"의 명령을 **개발 환경에서 직접** 실행해 주시면 됩니다. (자동 실행/스크립트 사용 없음)
