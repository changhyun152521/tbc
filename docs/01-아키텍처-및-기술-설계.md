# TBC CLASS — 1단계 MVP 아키텍처 및 기술 설계

> 기준: 1단계 MVP 범위 | 코드 작성 없음, 설계 문서만  
> 문서 버전: 1.0 | 작성일: 2025-02-05

---

## 목차

1. [전체 시스템 아키텍처](#1-전체-시스템-아키텍처)
2. [폴더 구조 제안](#2-폴더-구조-제안)
3. [기술 스택 세부 구성](#3-기술-스택-세부-구성)
4. [인증 구조 설계](#4-인증-구조-설계)
5. [역할(Role) 기반 권한 구조 설계](#5-역할-role-기반-권한-구조-설계)

---

## 1. 전체 시스템 아키텍처

### 1.1 개요

- **구조**: Monolith. Frontend(React) + Backend(Express) 단일 앱으로 배포 가능.
- **통신**: 브라우저 ↔ Backend REST API. MVP에서는 별도 BFF/API Gateway 없음.
- **데이터**: MongoDB 단일 DB. Redis 등 세션 저장소는 인증 방식에 따라 선택(세션 사용 시).

```
┌─────────────────────────────────────────────────────────────────┐
│                        Client (Browser)                          │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  React SPA (TypeScript) · 모바일 웹 우선 반응형              │ │
│  └─────────────────────────────────────────────────────────────┘ │
└───────────────────────────────┬─────────────────────────────────┘
                                │ HTTPS / REST API
                                │ (JSON, JWT in Header or Cookie)
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Backend (Node.js · Express)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Auth      │  │   RBAC      │  │  API Routes              │  │
│  │ Middleware  │→ │ Middleware  │→ │  (students, teachers,    │  │
│  │ (JWT/세션)  │  │ (role check)│  │   classes, progress, …)   │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  Config (TypeScript) — .env 사용 금지                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         MongoDB                                  │
│  users, students, parents, teachers, classes, classTeachers,   │
│  courses, lessons, progress, assignments, assignmentCompletions, │
│  tests, testScores                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 배포 관점 (참고)

- MVP 단계: Frontend 정적 빌드 → Backend에서 정적 파일 서빙 또는 별도 웹서버(Nginx 등)에서 서빙.
- Backend 단일 프로세스로 MongoDB만 연결. 수평 확장은 2단계 이후 검토.

### 1.3 보안·설정 정책

- **.env 미사용**: DB URL, JWT 시크릿 등 모든 설정은 TypeScript 기반 config 파일에서 로드 (예: `config/index.ts`, `config/database.ts`).
- **비밀번호**: 저장 시 bcrypt 등으로 해시만 저장.
- **HTTPS**: 운영 환경에서는 반드시 HTTPS 적용 (설계만 명시, 구현은 배포 단계).

---

## 2. 폴더 구조 제안

### 2.1 저장소 레이아웃

```
TBC-CLASS/
├── client/                    # Frontend (React + TypeScript)
│   ├── public/
│   ├── src/
│   │   ├── api/               # API 클라이언트 (axios/fetch 래퍼)
│   │   ├── components/        # 공통 컴포넌트
│   │   ├── layouts/           # 레이아웃 (헤더, 하단 탭, 사이드바 등)
│   │   ├── pages/             # 라우트별 페이지
│   │   │   ├── auth/          # 로그인 등
│   │   │   ├── admin/         # 관리자 전용
│   │   │   ├── teacher/       # 강사 전용
│   │   │   ├── student/        # 학생 전용
│   │   │   └── parent/        # 학부모 전용
│   │   ├── hooks/             # 커스텀 훅
│   │   ├── routes/            # 라우트 정의·보호
│   │   ├── store/             # 전역 상태 (Context 또는 Zustand 등, MVP에서 최소)
│   │   ├── types/             # 공통 타입
│   │   └── utils/
│   ├── index.html
│   ├── package.json
│   └── tsconfig.json
│
├── server/                    # Backend (Node.js + Express + TypeScript)
│   ├── src/
│   │   ├── config/            # 설정 (DB, JWT, 서버 포트 등) — .env 미사용
│   │   ├── middleware/        # auth, rbac, errorHandler 등
│   │   ├── routes/            # API 라우트 모듈
│   │   ├── controllers/       # 요청 처리 로직
│   │   ├── services/          # 비즈니스 로직
│   │   ├── models/            # MongoDB 스키마/모델 (Mongoose 등)
│   │   ├── types/             # 서버 전용 타입
│   │   └── app.ts             # Express 앱 조립
│   ├── index.ts               # 진입점
│   ├── package.json
│   └── tsconfig.json
│
├── docs/                      # 기획·설계 문서 (현재 문서들)
│   ├── 00-기획-설계-문서.md
│   ├── 01-아키텍처-및-기술-설계.md
│   ├── 02-DB-설계-상세.md
│   ├── 03-API-설계.md
│   └── 04-화면-구조-설계.md
│
└── package.json               # (선택) 루트 모노레포 스크립트
```

### 2.2 Backend 세부 폴더 (server/src)

| 경로 | 역할 |
|------|------|
| `config/` | `index.ts` 등에서 DB URI, JWT 시크릿·만료, 서버 포트 등 export. 환경별 분기는 파일 분리(예: config.development.ts) 또는 조건 분기로 처리. |
| `middleware/auth.ts` | JWT 검증 또는 세션 검증. `req.user`(id, role 등) 주입. |
| `middleware/rbac.ts` | `req.user.role` 기준 허용 역할 배열 검사. 403 반환. |
| `middleware/errorHandler.ts` | 공통 에러 핸들러. |
| `routes/` | 도메인별 라우터 (auth, students, teachers, classes, lessons, progress, assignments, tests, me 등). |
| `controllers/` | 라우트 → 컨트롤러 매핑. 요청 파싱·응답 반환. |
| `services/` | DB 접근·비즈니스 규칙(예: 학생 등록 시 ID/비밀번호 자동 생성). |
| `models/` | Mongoose Schema. User, Student, Parent, Teacher, Class, ClassTeacher, Course, Lesson, Progress, Assignment, AssignmentCompletion, Test, TestScore. |

### 2.3 Frontend 세부 폴더 (client/src)

| 경로 | 역할 |
|------|------|
| `api/` | baseURL 설정, 인증 헤더 첨부, 역할별 API 함수 (getStudents, getMyProgress 등). |
| `routes/` | React Router 정의. PublicRoute, RoleRoute(admin, teacher, student, parent)로 보호. |
| `pages/auth/` | 로그인 페이지. 로그인 성공 시 역할에 따라 리다이렉트. |
| `pages/admin/`, `teacher/`, `student/`, `parent/` | 역할별 페이지. 대시보드, 목록, 상세, 폼 등. |
| `layouts/` | AdminLayout, TeacherLayout, StudentLayout, ParentLayout (공통 메뉴·하단 탭). |

---

## 3. 기술 스택 세부 구성

### 3.1 Frontend

| 구분 | 기술 | 비고 |
|------|------|------|
| 언어 | TypeScript | strict 모드 권장 |
| 프레임워크 | React 18+ | 함수형 컴포넌트 + Hooks |
| 빌드 | Vite | 빠른 개발 서버·빌드 |
| 라우팅 | React Router v6 | 역할별 라우트 가드 |
| HTTP 클라이언트 | axios 또는 fetch | API 모듈에서 공통 처리 (인증 헤더 등) |
| 상태 | React Context 또는 Zustand | MVP에서는 로그인 사용자 정보·토큰 정도만 전역 관리 |
| UI | CSS Modules 또는 Tailwind CSS | 모바일 우선 반응형 |
| 폼 | 제어 컴포넌트 또는 react-hook-form | 로그인, 등록/수정 폼 |

### 3.2 Backend

| 구분 | 기술 | 비고 |
|------|------|------|
| 런타임 | Node.js 18+ | LTS |
| 언어 | TypeScript | strict |
| 프레임워크 | Express | |
| DB 클라이언트 | Mongoose | 스키마·검증·인덱스 정의 |
| 인증 | JWT (jsonwebtoken) 또는 express-session | 4장에서 선택안 명시 |
| 비밀번호 해시 | bcrypt | 저장·비교 전용 |
| 유효성 검사 | express-validator 또는 Joi | 요청 body/query 검증 |
| CORS | cors | 클라이언트 도메인 허용 |

### 3.3 Database

| 구분 | 기술 | 비고 |
|------|------|------|
| DB | MongoDB | 단일 인스턴스 |
| ODM | Mongoose | 스키마, 인덱스, 가상·메서드 |

### 3.4 설정

| 구분 | 기술 | 비고 |
|------|------|------|
| 설정 | TypeScript 파일 (config/*.ts) | .env 사용 금지. 환경별은 config.development.ts, config.production.ts 등 파일로 분리하거나, process.env.NODE_ENV로 분기. |

### 3.5 개발 도구

| 구분 | 기술 | 비고 |
|------|------|------|
| 패키지 관리 | npm 또는 pnpm | |
| 린트 | ESLint | |
| 포맷 | Prettier | |

---

## 4. 인증 구조 설계

### 4.1 방식 선택: JWT 권장

| 항목 | JWT | 세션 |
|------|-----|------|
| 확장성 | 서버 무상태, 수평 확장 용이 | 세션 저장소(Redis 등) 필요 |
| 모바일 웹 | Authorization 헤더로 토큰 전달 용이 | 쿠키 동일 사이트 정책 고려 필요 |
| 구현 단순성 | 발급·검증만 구현하면 됨 | 세션 저장·만료·재연결 처리 필요 |
| 로그아웃 | 클라이언트에서 토큰 삭제. 블랙리스트는 선택 | 세션 삭제로 즉시 무효화 |

**결정**: 1단계 MVP에서는 **JWT 기반 인증**을 기본안으로 설계. (세션은 “대안”으로만 기술.)

### 4.2 JWT 설계 상세

- **발급 시점**: 로그인 성공 시 (loginId + 비밀번호 검증 후).
- **Payload 권장 필드**  
  - `sub`: 사용자 ID (User._id).  
  - `role`: `admin` | `teacher` | `student` | `parent`.  
  - `iat`, `exp`: 발급·만료 시각.
- **만료**: Access Token만 사용 시 24시간 또는 7일 등 정책에 따라 설정. (설정은 config에서.)
- **전달 방식**: 클라이언트가 `Authorization: Bearer <token>` 헤더로 전달. (쿠키 저장 후 헤더에 붙이는 방식도 가능.)
- **Refresh Token**: MVP에서는 생략 가능. 만료 시 재로그인.

### 4.3 로그인 흐름

1. 클라이언트: POST `/api/auth/login` — body `{ loginId, password }`.
2. 서버: User 조회(loginId) → 비밀번호 비교(bcrypt) → 역할 확인.
3. 서버: JWT 생성(payload: sub=userId, role) → 200 + `{ token, user: { id, role, name? } }`.
4. 클라이언트: 토큰 저장(메모리 또는 localStorage) → 이후 요청에 Bearer 헤더 설정.
5. 서버: `middleware/auth`: Authorization에서 토큰 추출 → 검증 → `req.user = { id, role }` 주입.

### 4.4 대안: 세션

- express-session + MongoDB store(connect-mongo) 또는 Redis.
- 로그인 성공 시 `req.session.userId`, `req.session.role` 저장.
- 쿠키로 세션 ID 전달. SameSite/Secure 정책 적용.
- 로그아웃 시 `req.session.destroy()`.

---

## 5. 역할(Role) 기반 권한 구조 설계

### 5.1 역할 정의

| Role | 설명 | 식별자 |
|------|------|--------|
| admin | 관리자(원장) | `admin` |
| teacher | 강사 | `teacher` |
| student | 학생 | `student` |
| parent | 학부모 | `parent` |

- 한 사용자(User)는 **하나의 역할만** 가짐. (한 계정에 여러 역할 없음.)

### 5.2 권한 체크 위치

1. **라우트 단위**: 특정 라우트는 특정 역할만 접근 가능.  
   예: `GET /api/admin/students` → `admin` 만.
2. **리소스 단위**: 같은 API라도 “본인/담당 반/자녀”만 볼 수 있도록 서비스 레이어에서 필터.  
   예: 강사가 `GET /api/classes` 호출 시 본인이 담당인 반만 반환.

### 5.3 역할별 접근 매트릭스 (개념)

| 리소스/기능 | admin | teacher | student | parent |
|-------------|-------|---------|---------|--------|
| 학생 CRUD (전체) | ✅ | ❌ | ❌ | ❌ |
| 강사 CRUD | ✅ | ❌ | ❌ | ❌ |
| 반 CRUD, 반–강사 | ✅ | ❌ | ❌ | ❌ |
| 반 목록 (담당만) | ✅ 전체 | ✅ 담당만 | ❌ | ❌ |
| 수업(Lesson) CRUD | ✅ | ✅ 담당 반만 | ❌ | ❌ |
| 진도(Progress) 입력/수정 | ✅ | ✅ 담당 반만 | ❌ | ❌ |
| 과제(Assignment) CRUD, 완료 체크 | ✅ | ✅ 담당 반만 | ❌ | ❌ |
| 테스트(Test) CRUD, 점수 입력 | ✅ | ✅ 담당 반만 | ❌ | ❌ |
| 내 진도/과제/테스트 조회 | ❌ | ❌ | ✅ 본인 | ❌ |
| 자녀 진도/과제/테스트 조회 | ✅ | ❌ | ❌ | ✅ 연결 자녀 1명 |
| 내정보(본인 ID/비밀번호/전화번호) 수정 | ✅ 본인 | ✅ 본인 | ✅ 본인 | ✅ 본인 |
| 대시보드 요약 | ✅ 학원 전체 | ✅ 담당 반 | ✅ 본인 | ✅ 자녀 1명 |

### 5.4 미들웨어 동작

- **auth**: JWT 검증 → 실패 시 401. 성공 시 `req.user = { id, role }` 설정. (필요 시 `loginId`, `studentId` 등 추가.)
- **rbac(allowedRoles)**: `req.user.role`이 `allowedRoles`에 없으면 403.
- **사용 예**  
  - `router.get('/admin/students', auth, rbac(['admin']), listStudents)`  
  - `router.get('/classes', auth, rbac(['admin','teacher']), listClasses)` — listClasses 내부에서 teacher면 담당 반만 필터.

### 5.5 리소스 단위 제한 (서비스 레이어)

- **강사**: 반·수업·진도·과제·테스트 모두 “본인이 ClassTeacher로 지정된 반”에 한해 접근.
- **학생**: 진도/과제/테스트는 `studentId === req.user 연결 Student._id` 인 데이터만.
- **학부모**: Parent 문서에서 `studentId` 조회 후, 해당 학생의 진도/과제/테스트만 노출.

---

## 문서 이력

| 버전 | 일자 | 변경 내용 |
|------|------|-----------|
| 1.0 | 2025-02-05 | 초안 (아키텍처, 폴더, 기술스택, 인증, RBAC) |
