# 5단계: 강사용 기능 API 구현 — 결과 보고

> 기준 문서: `docs/00-기획-설계-문서.md`, `docs/02-DB-설계-상세.md`  
> 작성일: 2025-02-05

---

## 1. 수정/추가된 파일 목록

### [1] 전화번호·계정 생성 규칙 변경 반영

| 파일 | 변경 내용 |
|------|------------|
| `backend/src/services/admin/student.service.ts` | 전화번호 가공 없이 저장. 미입력 시 `studentPhone`/`parentPhone`을 그대로 loginId·password로 사용 |
| `backend/src/services/auth.service.ts` | 로그인 시 전화번호 문자열 그대로 사용 (가공 없이 DB 값과 비교) |
| `backend/src/services/me.service.ts` | 내정보 전화번호 수정 시 `trim` 제거 — 입력값 그대로 저장 |
| `backend/src/routes/admin.routes.ts` | 학생 전화번호: 형식 제한 없음 (notEmpty만 유지) |

### [2] 5단계 강사 API 신규/수정

| 파일 | 구분 | 설명 |
|------|------|------|
| `backend/src/routes/teacher.routes.ts` | 수정 | 강사 전용 라우트: authenticate + requireRoles(['admin','teacher']) |
| `backend/src/controllers/teacher.controller.ts` | 수정 | 반·수업·테스트·점수 API 컨트롤러 |
| `backend/src/services/teacher/teacherClass.service.ts` | 수정 | 담당 반 목록, 반별 학생 목록, 반 접근 권한(canAccessClass) |
| `backend/src/services/teacher/teacherLesson.service.ts` | 수정 | 수업 CRUD, 목록/조회/수정/삭제 (출석·과제는 수정 API로 처리) |
| `backend/src/services/teacher/teacherTest.service.ts` | 수정 | 테스트 CRUD, 점수 목록 조회, 점수 입력/수정(upsert) |
| `backend/src/app.ts` | 기존 | `/api/teacher`에 teacher 라우트 마운트 (이미 반영됨) |

---

## 2. 구현된 API 목록

모든 API는 **인증 필수**이며, **admin** 또는 **teacher** 역할만 호출 가능합니다.  
강사는 `Class.teacherIds`에 본인(Teacher)이 포함된 반만 접근 가능하고, **admin**은 전체 접근 가능합니다.

### 2.1 반(Class)

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/teacher/classes` | 강사 담당 반 목록 (admin: 전체) |
| GET | `/api/teacher/classes/:classId/students` | 특정 반의 학생 목록 (Student.classId 기준) |

### 2.2 수업(Lesson)

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/teacher/classes/:classId/lessons` | 해당 반 수업 목록 (쿼리: from, to 선택) |
| POST | `/api/teacher/classes/:classId/lessons` | 수업 생성 (date, period 필수) |
| GET | `/api/teacher/lessons/:lessonId` | 수업 단건 조회 |
| PUT | `/api/teacher/lessons/:lessonId` | 수업 수정 (진도, 과제, **출석**, **과제 완료** 포함) |
| DELETE | `/api/teacher/lessons/:lessonId` | 수업 삭제 |

- **출석 체크**: `PUT /api/teacher/lessons/:lessonId` body에 `attendanceStatus` 로 처리  
- **과제 완료 처리**: 동일 API body에 `homeworkDone: true/false` 로 처리  

### 2.3 테스트(Test)

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/teacher/classes/:classId/tests` | 해당 반 테스트 목록 |
| POST | `/api/teacher/classes/:classId/tests` | 테스트 등록 (testType, date 필수) |
| GET | `/api/teacher/tests/:testId` | 테스트 단건 조회 |
| PUT | `/api/teacher/tests/:testId` | 테스트 수정 (날짜, 과목, 단원 등) |
| DELETE | `/api/teacher/tests/:testId` | 테스트 삭제 |
| GET | `/api/teacher/tests/:testId/scores` | 해당 테스트 점수 목록(학생별) |
| POST | `/api/teacher/tests/:testId/scores` | 점수 입력/수정 (studentId, score) |

---

## 3. 각 API별 테스트 방법 예시

- **공통**: 먼저 `POST /api/auth/login`으로 admin 또는 teacher 계정 로그인 후 받은 `token`을  
  요청 헤더에 `Authorization: Bearer <token>` 으로 넣어 사용합니다.

### 3.1 강사 담당 반 목록

```http
GET /api/teacher/classes
Authorization: Bearer <token>
```

- **기대**: 200, `{ success: true, data: [ { _id, name, teacherIds, ... } ] }`  
- 강사인 경우 본인 담당 반만, admin이면 전체 반 목록.

### 3.2 특정 반 학생 목록

```http
GET /api/teacher/classes/<classId>/students
Authorization: Bearer <token>
```

- **기대**: 200, `{ success: true, data: [ 학생 배열 ] }`  
- 권한 없으면 404.

### 3.3 수업 생성

```http
POST /api/teacher/classes/<classId>/lessons
Authorization: Bearer <token>
Content-Type: application/json

{
  "date": "2025-02-10",
  "period": "1교시",
  "progress": "1단원 1절",
  "homework": "p.10~12",
  "attendanceStatus": "출석",
  "homeworkDone": false
}
```

- **기대**: 201, `{ success: true, data: lesson }`  
- date, period 필수.

### 3.4 수업 조회 / 수정 (출석·과제 완료 포함)

```http
GET /api/teacher/lessons/<lessonId>
Authorization: Bearer <token>
```

```http
PUT /api/teacher/lessons/<lessonId>
Authorization: Bearer <token>
Content-Type: application/json

{
  "attendanceStatus": "출석",
  "homeworkDone": true
}
```

- 출석만 바꾸거나, 과제 완료만 바꿀 수도 있고, 둘 다 보내도 됨.

### 3.5 테스트 등록

```http
POST /api/teacher/classes/<classId>/tests
Authorization: Bearer <token>
Content-Type: application/json

{
  "testType": "weeklyTest",
  "date": "2025-02-15",
  "subject": "수학",
  "bigUnit": "1단원",
  "smallUnit": "1절"
}
```

- testType: `weeklyTest` | `realTest`, date 필수.

### 3.6 점수 조회 / 점수 입력

```http
GET /api/teacher/tests/<testId>/scores
Authorization: Bearer <token>
```

```http
POST /api/teacher/tests/<testId>/scores
Authorization: Bearer <token>
Content-Type: application/json

{
  "studentId": "<student ObjectId>",
  "score": 85
}
```

- 동일 studentId로 다시 보내면 점수만 갱신(upsert).

---

## 4. Postman 테스트 예시 (요청/응답)

### 4.1 로그인 (admin 또는 teacher)

**요청**

```http
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "loginId": "admin",
  "password": "admin123"
}
```

**응답 예시**

```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": { "id": "...", "role": "admin", "name": "관리자" }
  }
}
```

---

### 4.2 담당 반 목록

**요청**

```http
GET {{baseUrl}}/api/teacher/classes
Authorization: Bearer {{token}}
```

**응답 예시**

```json
{
  "success": true,
  "data": [
    {
      "_id": "65f...",
      "name": "중1 수학 A반",
      "teacherIds": [{ "_id": "...", "name": "김강사" }],
      "studentIds": [],
      "description": ""
    }
  ]
}
```

---

### 4.3 반별 학생 목록

**요청**

```http
GET {{baseUrl}}/api/teacher/classes/65f.../students
Authorization: Bearer {{token}}
```

**응답 예시**

```json
{
  "success": true,
  "data": [
    {
      "_id": "65f...",
      "name": "홍길동",
      "school": "OO중",
      "grade": "중1",
      "classId": "65f...",
      "userId": { "name": "홍길동", "loginId": "010-1234-5678" }
    }
  ]
}
```

---

### 4.4 수업 생성

**요청**

```http
POST {{baseUrl}}/api/teacher/classes/65f.../lessons
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "date": "2025-02-10",
  "period": "1교시",
  "progress": "1단원 1절",
  "homework": "p.10~12"
}
```

**응답 예시**

```json
{
  "success": true,
  "data": {
    "_id": "65f...",
    "classId": "65f...",
    "date": "2025-02-10T00:00:00.000Z",
    "period": "1교시",
    "progress": "1단원 1절",
    "homework": "p.10~12",
    "attendanceStatus": "",
    "homeworkDone": false,
    "createdAt": "...",
    "updatedAt": "..."
  }
}
```

---

### 4.5 수업 수정 (출석·과제 완료)

**요청**

```http
PUT {{baseUrl}}/api/teacher/lessons/65f.../...
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "attendanceStatus": "출석",
  "homeworkDone": true
}
```

**응답 예시**

```json
{
  "success": true,
  "data": {
    "_id": "65f...",
    "attendanceStatus": "출석",
    "homeworkDone": true,
    ...
  }
}
```

---

### 4.6 테스트 등록

**요청**

```http
POST {{baseUrl}}/api/teacher/classes/65f.../tests
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "testType": "weeklyTest",
  "date": "2025-02-15"
}
```

**응답 예시**

```json
{
  "success": true,
  "data": {
    "_id": "65f...",
    "classId": "65f...",
    "testType": "weeklyTest",
    "date": "2025-02-15T00:00:00.000Z",
    "scores": [],
    "createdAt": "...",
    "updatedAt": "..."
  }
}
```

---

### 4.7 점수 입력

**요청**

```http
POST {{baseUrl}}/api/teacher/tests/65f.../scores
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "studentId": "65f...",
  "score": 85
}
```

**응답 예시**

```json
{
  "success": true,
  "data": {
    "_id": "65f...",
    "scores": [
      { "studentId": "65f...", "score": 85 }
    ],
    ...
  }
}
```

---

### 4.8 점수 목록 조회

**요청**

```http
GET {{baseUrl}}/api/teacher/tests/65f.../scores
Authorization: Bearer {{token}}
```

**응답 예시**

```json
{
  "success": true,
  "data": [
    { "studentId": "65f...", "studentName": "홍길동", "score": 85 }
  ]
}
```

---

## 5. 정책 요약

- **인증**: 모든 강사 API `authenticate` + `requireRoles(['admin', 'teacher'])` 적용.
- **권한**: 강사는 `Class.teacherIds`에 본인 Teacher가 포함된 반만 접근. admin은 전체.
- **학생 목록**: `Student.classId` 기준으로 해당 반 학생 조회.
- **출석/과제**: 수업 수정 API(`PUT /api/teacher/lessons/:lessonId`)에서 `attendanceStatus`, `homeworkDone` 필드로 처리.
- **전화번호 정책**: 입력값 그대로 저장·사용. ID/비밀번호 자동 생성 시에도 전화번호 문자열 가공 없이 사용.

이상으로 5단계 강사용 기능 API 구현 및 전화번호·계정 규칙 반영 결과를 마칩니다.
